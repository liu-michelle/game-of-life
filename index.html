<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Map Music & Path Tracker</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <style>
      body {
        font-family: Arial, sans-serif;
        margin: 0;
        padding: 20px;
        background: #f0f0f0;
      }
      h1 {
        text-align: center;
        margin-bottom: 20px;
      }
      #map {
        height: 500px;
        width: 100%;
        max-width: 800px;
        margin: 0 auto;
        border: 2px solid #ccc;
      }
      #coords {
        text-align: center;
        margin-top: 10px;
        font-size: 18px;
        background: rgba(255, 255, 255, 0.9);
        display: inline-block;
        padding: 5px 10px;
        border-radius: 4px;
      }
    </style>
  </head>
  <body>
    <h1>Map Music & Path Tracker</h1>
    <div id="map"></div>
    <div id="coords">Lat: --, Lng: --</div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- Tone JS -->
    <script src="https://unpkg.com/tone/build/Tone.js"></script>
    <script>
      // Create the map and center it over New York City.
      var map = L.map("map").setView([40.7128, -74.0060], 13);
      L.tileLayer("https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png", {
        maxZoom: 17,
        attribution:
          'Map data: &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
          '<a href="http://viewfinderpanoramas.org">SRTM</a> | ' +
          'Map style: &copy; <a href="https://opentopomap.org">OpenTopoMap</a> ' +
          '(<a href="https://creativecommons.org/licenses/by-sa/3.0/">CC-BY-SA</a>)'
      }).addTo(map);

      // Create a marker that follows the mouse.
      var hoverMarker = L.marker([40.7128, -74.0060]).addTo(map);
      var coordsDiv = document.getElementById("coords");

      // Create a polyline to draw the path
      var pathCoordinates = [];
      var polyline = L.polyline(pathCoordinates, { color: 'red' }).addTo(map);

      // Create a Tone.js synth and connect it to the destination.
      const synth = new Tone.Synth().toDestination();

      // Throttle note triggering to prevent overwhelming sound events.
      let lastTriggerTime = 0;
      const triggerInterval = 200; // in milliseconds

      // Utility function to map a number from one range to another.
      function mapRange(value, inMin, inMax, outMin, outMax) {
        return outMin + ((value - inMin) * (outMax - outMin)) / (inMax - inMin);
      }

      // On mouse move over the map, update marker position, draw path, display coordinates, and trigger a note.
      map.on("mousemove", function (e) {
        // Update marker location.
        hoverMarker.setLatLng(e.latlng);

        // Update coordinate display.
        coordsDiv.textContent =
          "Lat: " +
          e.latlng.lat.toFixed(4) +
          ", Lng: " +
          e.latlng.lng.toFixed(4);

        // Add new point to the path.
        pathCoordinates.push(e.latlng);
        polyline.setLatLngs(pathCoordinates);

        // Throttle note triggering.
        const now = Date.now();
        if (now - lastTriggerTime > triggerInterval) {
          lastTriggerTime = now;

          // Map latitude (-90 to 90) to frequency (200 Hz to 1000 Hz).
          const freq = mapRange(e.latlng.lat, -90, 90, 200, 1000);

          // Map longitude (-180 to 180) to a detune value (-50 to 50 cents).
          const detune = mapRange(e.latlng.lng, -180, 180, -50, 50);
          synth.detune.value = detune;

          // Trigger a short note.
          synth.triggerAttackRelease(freq, "8n", undefined, 0.5);
        }
      });
    </script>
  </body>
</html>
